<script>
        // --- Initialize Supabase ---
        const SUPABASE_URL = 'https://mrowwjmahjpejunhmvrs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yb3d3am1haGpwZWp1bmhtdnJzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NDUwMzYsImV4cCI6MjA3NzQyMTAzNn0.5-lmxomtOaYxaV0dfch--HSYEo0Z79yDxgdF7IdCgvw';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Global App State ---
        let currentUser = null;
        let currentNoteId = null; // For the share modal

        // --- DOM Elements ---
        const loadingDiv = document.getElementById('loading');
        const authContainer = document.getElementById('auth-container');
        const notesContainer = document.getElementById('notes-container');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const toggleToSignup = document.getElementById('toggle-to-signup');
        const toggleToLogin = document.getElementById('toggle-to-login');
        const loginButton = document.getElementById('login-button');
        const signupButton = document.getElementById('signup-button');
        const logoutButton = document.getElementById('logout-button');
        const loginError = document.getElementById('login-error');
        const signupError = document.getElementById('signup-error');
        const noteInput = document.getElementById('note-input');
        const saveButton = document.getElementById('save-button');
        const notesList = document.getElementById('notes-list');

        // --- Share Modal Elements ---
        const shareModal = document.getElementById('share-modal');
        const shareEmailInput = document.getElementById('share-email');
        const sharePermissionInput = document.getElementById('share-permission');
        const shareSaveButton = document.getElementById('share-save-button');
        const shareCloseButton = document.getElementById('share-close-button');
        const shareError = document.getElementById('share-error');
        const currentSharesList = document.getElementById('current-shares-list');


        // --- MASTER AUTH LOGIC ---
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (session) {
                currentUser = session.user;
                notesContainer.style.display = 'block';
                authContainer.style.display = 'none';
                loadingDiv.style.display = 'none';
                loadNotes();
            } else {
                currentUser = null;
                notesContainer.style.display = 'none';
                authContainer.style.display = 'block';
                loadingDiv.style.display = 'none';
                notesList.innerHTML = '';
            }
        });

        // --- AUTH EVENT HANDLERS ---
        toggleToSignup.onclick = () => {
            loginForm.classList.remove('active');
            signupForm.classList.add('active');
        };
        toggleToLogin.onclick = () => {
            signupForm.classList.remove('active');
            loginForm.classList.add('active');
        };

        signupButton.onclick = async () => {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            signupError.textContent = "";
            if (!email || !password) {
                signupError.textContent = "Please enter an email and password.";
                return;
            }
            const { data, error } = await supabaseClient.auth.signUp({
                email: email,
                password: password,
            });
            if (error) {
                signupError.textContent = error.message;
            } else {
                // This message appears if email confirmation is ON in your project
                signupError.textContent = "Sign up successful! Please check your email to verify.";
                document.getElementById('signup-email').value = "";
                document.getElementById('signup-password').value = "";
            }
        };

        loginButton.onclick = async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            loginError.textContent = "";
            if (!email || !password) {
                loginError.textContent = "Please enter an email and password.";
                return;
            }
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email: email,
                password: password,
            });
            if (error) {
                loginError.textContent = error.message;
            }
        };

        logoutButton.onclick = async () => {
            await supabaseClient.auth.signOut();
        };

        // --- NOTES APP LOGIC ---

        /**
         * Loads all notes user can see (owned and shared).
         */
        async function loadNotes() {
            if (!currentUser) return;
            notesList.innerHTML = '<p class="empty-state">Loading...</p>';
            try {
                // 1. Get all notes user can see (thanks to RLS)
                const { data: notes, error: notesError } = await supabaseClient
                    .from('notes')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (notesError) throw notesError;

                // 2. Get all share info related to the user
                const { data: shares, error: sharesError } = await supabaseClient
                    .from('note_shares')
                    .select('*');
                if (sharesError) throw sharesError;

                // 3. Create a "lookup map" for permissions on notes shared *with me*
                const sharePermissions = new Map();
                if (shares) {
                    shares.forEach(share => {
                        if (share.shared_with_email === currentUser.email) {
                            sharePermissions.set(share.note_id, share.permission_level);
                        }
                    });
                }

                notesList.innerHTML = ''; // Clear list
                if (!notes || notes.length === 0) {
                    notesList.innerHTML = '<p class="empty-state">No notes saved yet.</p>';
                    return;
                }

                // 4. Render each note with its correct permission
                notes.forEach(note => {
                    const isOwner = note.user_id === currentUser.id;
                    const sharedPermission = sharePermissions.get(note.id);
                    
                    let permission = 'none';
                    if (isOwner) {
                        permission = 'owner';
                    } else if (sharedPermission) {
                        permission = sharedPermission; // 'view' or 'edit'
                    }
                    
                    renderNote(note, permission);
                });

            } catch (error) {
                console.error("Error loading notes: ", error);
                notesList.innerHTML = '<p class="empty-state">Error loading notes.</p>';
            }
        }

        /**
         * Renders a single note item based on permission
         */
        function renderNote(note, permission) {
            const noteElement = document.createElement('div');
            noteElement.classList.add('note-item');
            noteElement.setAttribute('data-note-id', note.id); 

            const noteText = document.createElement('div');
            noteText.classList.add('note-text');
            noteText.textContent = note.text;

            const noteMeta = document.createElement('div');
            noteMeta.classList.add('note-meta');

            const noteActions = document.createElement('div');
            noteActions.classList.add('note-actions');

            if (permission === 'owner') {
                noteText.contentEditable = true;
                let saveTimeout;
                noteText.addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        handleUpdateNote(note.id, noteText.textContent);
                    }, 1000); // Save 1 second after user stops typing
                });

                const shareBtn = document.createElement('button');
                shareBtn.classList.add('share-button');
                shareBtn.innerHTML = '&#128101;'; // Share icon
                shareBtn.title = "Share note";
                shareBtn.onclick = () => openShareModal(note.id);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-button');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.title = "Delete note";
                deleteBtn.onclick = () => deleteNote(note.id);

                noteActions.append(shareBtn, deleteBtn);

            } else if (permission === 'edit') {
                noteText.contentEditable = true;
                let saveTimeout;
                noteText.addEventListener('input', () => {
                    clearTimeout(saveTimeout);
                    saveTimeout = setTimeout(() => {
                        handleUpdateNote(note.id, noteText.textContent);
                    }, 1000); // Save 1 second after user stops typing
                });
                noteMeta.textContent = "Shared with you (Edit)";

            } else if (permission === 'view') {
                noteText.contentEditable = false;
                noteElement.classList.add('shared-view');
                noteMeta.textContent = "Shared with you (View only)";
            }

            noteElement.append(noteText, noteMeta, noteActions);
            notesList.appendChild(noteElement);
        }

        /**
         * Deletes a note from Supabase (Owner only).
         */
        async function deleteNote(noteId) {
            if (confirm("Are you sure you want to delete this note?")) {
                try {
                    const { error } = await supabaseClient
                        .from('notes')
                        .delete()
                        .eq('id', noteId);
                    if (error) throw error;
                    
                    loadNotes(); // Manually refresh list
                } catch (error) {
                    console.error("Error deleting note: ", error);
                }
            }
        }

        /**
         * Saves a NEW note.
         */
        async function handleSaveNote() {
            if (!currentUser) return;
            const newNoteText = noteInput.value.trim();
            if (newNoteText) {
                saveButton.disabled = true;
                saveButton.textContent = "Saving...";
                try {
                    const { error } = await supabaseClient
                        .from('notes')
                        .insert({ text: newNoteText, user_id: currentUser.id });
                    if (error) throw error;
                    noteInput.value = ''; // Clear the input
                    
                    loadNotes(); // Manually refresh list
                } catch (error)
                    console.error("Error saving note: ", error);
                }
                saveButton.disabled = false;
                saveButton.textContent = "Save Note";
            }
        }
        
        /**
         * Updates an EXISTING note
         */
        async function handleUpdateNote(noteId, newText) {
            try {
                const { error } = await supabaseClient
                    .from('notes')
                    .update({ text: newText })
                    .eq('id', noteId);

                if (error) {
                    alert("Error saving: " + error.message);
                    throw error;
                }
                // No need to call loadNotes() here, as it's disruptive.
                // The user's screen is already up to date.
            } catch (error) {
                console.error("Error updating note:", error);
            }
        }

        saveButton.addEventListener('click', handleSaveNote);


        // --- SHARE MODAL LOGIC ---
        
        shareCloseButton.onclick = () => {
            shareModal.style.display = 'none';
        };

        async function openShareModal(noteId) {
            currentNoteId = noteId;
            shareEmailInput.value = '';
            shareError.textContent = '';
            shareModal.style.display = 'flex';
            loadCurrentShares(noteId);
        }

        async function loadCurrentShares(noteId) {
            currentSharesList.innerHTML = '<p class="empty-state">Loading...</p>';
            try {
                const { data: shares, error } = await supabaseClient
                    .from('note_shares')
                    .select('*')
                    .eq('note_id', noteId);
                
                if (error) throw error;

                if (!shares || shares.length === 0) {
                    currentSharesList.innerHTML = '<p class="empty-state">Not shared with anyone yet.</p>';
                    return;
                }

                currentSharesList.innerHTML = '';
                shares.forEach(share => {
                    const item = document.createElement('div');
                    item.classList.add('share-item');
                    item.innerHTML = `
                        <div>
                            <span class="share-item-email">${share.shared_with_email}</span>
                        </div>
                        <div>
                            <span class="share-item-permission">${share.permission_level}</span>
                            <button class="unshare-button" title="Remove share">&times;</button>
                        </div>
                    `;
                    item.querySelector('.unshare-button').onclick = () => removeShare(share.id);
                    currentSharesList.appendChild(item);
                });

            } catch (error) {
                console.error("Error loading shares:", error);
                currentSharesList.innerHTML = '<p class="empty-state">Error loading shares.</p>';
            }
        }

        shareSaveButton.onclick = async () => {
            const email = shareEmailInput.value;
            const permission = sharePermissionInput.value;
            
            if (!email) {
                shareError.textContent = "Please enter an email.";
                return;
            }
            if (email === currentUser.email) {
                shareError.textContent = "You cannot share a note with yourself.";
                return;
            }

            shareSaveButton.disabled = true;
            shareError.textContent = "";

            try {
                const { error } = await supabaseClient
                    .from('note_shares')
                    .insert({
                        note_id: currentNoteId,
                        shared_by_user_id: currentUser.id,
                        shared_with_email: email,
                        permission_level: permission
                    });

                if (error) {
                    if (error.code === '23505') { // Unique constraint violation
                        shareError.textContent = "Already shared with this user.";
                    } else {
                        throw error;
                    }
                } else {
                    shareEmailInput.value = ''; // Clear input on success
                    loadCurrentShares(currentNoteId); // Refresh modal list
                    loadNotes(); // Refresh main notes list to show meta tag
                }
            } catch (error) {
                console.error("Error sharing note:", error);
                shareError.textContent = "Error: " + error.message;
            }
            shareSaveButton.disabled = false;
        };

        async function removeShare(shareId) {
            try {
                const { error } = await supabaseClient
                    .from('note_shares')
                    .delete()
                    .eq('id', shareId);
                
                if (error) throw error;
                loadCurrentShares(currentNoteId); // Refresh modal list
                loadNotes(); // Refresh main notes list
            } catch (error) {
                console.error("Error removing share:", error);
                shareError.textContent = "Error: " + error.message;
            }
        }
    </script>
</body>
</html>
